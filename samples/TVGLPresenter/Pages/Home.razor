@page "/"
@using System.Numerics
@using System.Drawing
@using BugViewer
@using TVGL
@using TVGLPresenter.Components

<PageTitle>Home</PageTitle>
<InputFile OnChange="OpenFile" />
<BugViewer @ref="viewer" />
<LogViewer @ref="logViewer"  />

@code {
	private BugViewer? viewer;
	private LogViewer logViewer = new()!;

	protected override void OnAfterRender(bool firstRender)
	{
		if (firstRender)
		{
			TVGL.Global.Logger = logViewer;
		}
	}
	private async Task OpenFile(InputFileChangeEventArgs args)
	{
		var fileArgs = args.GetMultipleFiles(1)[0];
		string filename = fileArgs.Name;
		logViewer.LogInformation($"Loaded polygon from {filename}");
		TVGL.Global.Logger.LogInformation("whaletakt");
		
		// Buffer the file into a MemoryStream to allow synchronous reads.
		await using var memoryStream = new MemoryStream();
		// The OpenReadStream provides a stream that must be read asynchronously.
		await using (var stream = fileArgs.OpenReadStream(long.MaxValue))
		{
			await stream.CopyToAsync(memoryStream);
		}
		// Reset the position to the beginning of the stream.
		memoryStream.Position = 0;

		IO.Open(memoryStream, filename, out TessellatedSolid[] tss);
		var ts = tss[0];
		MeshData meshData;
		meshData = new MeshData
		{
			ColorMode = ts.HasUniformColor ? MeshColoring.UniformColor : MeshColoring.PerTriangle,
			Id = Path.GetFileName(filename),
			Colors = ts.HasUniformColor ? [ConvertFromTVGLColor(ts.SolidColor)]
			: ts.Faces.Select(f => ConvertFromTVGLColor(f.Color)),
			Indices = ts.Faces.Select(f => (f.A.IndexInList, f.B.IndexInList, f.C.IndexInList)),
			Vertices = ts.Vertices.Select(v => new System.Numerics.Vector3((float)v.X/100f, (float)v.Y/100f, (float)v.Z/100f))
		};
		// Add to WebGPU scene
		await viewer.AddMeshAsync(meshData);
	}

	private static System.Drawing.Color ConvertFromTVGLColor(TVGL.Color c)
				=> System.Drawing.Color.FromArgb(c.A, c.R, c.G, c.B);
}