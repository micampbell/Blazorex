@using Blazor3D.Models
@inject IJSRuntime JS
@implements IAsyncDisposable

<canvas id="webgpu-canvas"
		class="webgpu-canvas"
        style="height:100%; width:100%;"
        @ref="_canvasRef">
</canvas>
@*    
		style="height:@($"{Height}px"); width:100%;"
        width="@Width"
        height="@Height"
    how to change the height
Or, put it in a container with a fixed height and keep the canvas at height: 100% inside that container, but the change above to tiny-webgpu-demo.js is the key fix.
*@
@code {
    [Parameter]
    public int Width { get; set; } = 800;

    [Parameter]
    public int Height { get; set; } = 600;

    // Grid options translated to C#
    [Parameter]
    public ColorRgba SkyColor { get; set; } = new ColorRgba(0,0,0.5,1);

    [Parameter]
    public ColorRgba LineColor { get; set; } = new ColorRgba(1,1,1,1);

    [Parameter]
    public ColorRgba BaseColor { get; set; } = new ColorRgba(0.01,0.1,0.01,0.1);

    private double _lineWidthX = 0.2;
    private double _lineWidthY = 0.2;

    [Parameter]
    public double LineWidthX
    {
        get => _lineWidthX;
        set => _lineWidthX = Math.Clamp(value, 0.0, 1.0); // Validate in C#
    }

    [Parameter]
    public double LineWidthY
    {
        get => _lineWidthY;
        set => _lineWidthY = Math.Clamp(value, 0.0, 1.0); // Validate in C#
    }

    // Camera / device configuration 
    [Parameter]
    public int SampleCount { get; set; } = 4;

    [Parameter]
    public double Fov { get; set; } = Math.PI * 0.5; // radians

    [Parameter]
    public double ZNear { get; set; } = 0.01;

    [Parameter]
    public double ZFar { get; set; } = 128;

    private ElementReference _canvasRef;
    private IJSObjectReference? _module;
    private DotNetObjectReference<WebGPUCanvas>? _dotNetRef;
    private bool _ready;
    private string? _error;
    public double LatestFrameMs { get; private set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // One-time initialization: import module and create .NET reference
        _module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/webgpu-canvas.js");
        _dotNetRef = DotNetObjectReference.Create(this);

        // Send initial options (this triggers the render loop in JS)
        await SendOptionsToJavaScriptAsync(isInitializing: true);
    }

    protected override async Task OnParametersSetAsync()
    {
        // Only send updates after the module is loaded (after first render)
        await SendOptionsToJavaScriptAsync(isInitializing: false);
    }

    private async Task SendOptionsToJavaScriptAsync(bool isInitializing)
    {
        // Guard: module must be loaded (happens after first render)
        if (_module is null) return;

        var options = new WebGpuGridOptions
        {
            ClearColor = SkyColor,
            LineColor = LineColor,
            BaseColor = BaseColor,
            LineWidthX = LineWidthX,
            LineWidthY = LineWidthY,
            SampleCount = SampleCount,
            Fov = Fov,
            ZNear = ZNear,
            ZFar = ZFar
        };

        if (isInitializing)
        {
            await _module.InvokeVoidAsync("initGridDemo", _dotNetRef, _canvasRef, options);
        }
        else
        {
            await _module.InvokeVoidAsync("updateGridOptions", options);
        }
    }

    [JSInvokable]
    public Task OnWebGpuReady()
    {
        _ready = true;
        _error = null;
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnWebGpuError(string message)
    {
        _ready = false;
        _error = message;
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnFrameMsUpdate(double ms)
    {
        LatestFrameMs = ms;
        // No StateHasChanged to avoid re-render per frame; consumer can bind to events if desired
        return Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            try { await _module.InvokeVoidAsync("disposeGridDemo"); } catch { /* ignore */ }
            try { await _module.DisposeAsync(); } catch { /* ignore */ }
        }

        _dotNetRef?.Dispose();
    }
}
