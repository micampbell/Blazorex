@using System.Drawing
@using Bit.BlazorUI

<div class="options-panel-container @(IsExpanded ? "expanded" : "collapsed")">
	<BitButton OnClick="ToggleExpanded"
			   Variant="BitVariant.Text"
			   Class="toggle-btn">
		@(IsExpanded ? "⚙️ Viewer Settings ▼" : "⚙️")
	</BitButton>

	@if (IsExpanded)
	{
		<div class="options-content">
			<BitAccordion Title="Lighting">
				<!-- Use a single column so the picker can consume the panel width -->
				<BitGrid Columns="1">
					<BitGridItem><BitLabel>Clear Color (Sky)</BitLabel></BitGridItem>
					<BitGridItem>
						<BitColorPicker Style="width:100%; max-width:100%;"
										@bind-Color="Options.ClearColor" />
					</BitGridItem>
				</BitGrid>
			</BitAccordion>

			<BitAccordion Title="📐 Grid">
				<BitStack>
					<BitSlider Label="Grid Size" @bind-Value="Options.GridSize" Min="50" Max="1000" Step="1" />
					<BitSlider Label="Grid Spacing" @bind-Value="Options.GridSpacing" Min="1" Max="100" Step="0.5" />
					<BitSlider Label="Line Width X" @bind-Value="Options.LineWidthX" Min="0" Max="1" Step="0.01" />
					<BitSlider Label="Line Width Y" @bind-Value="Options.LineWidthY" Min="0" Max="1" Step="0.01" />

					<BitLabel>Grid Line Color</BitLabel>
					<BitColorPicker  Style="width:100%; max-width:100%;"
									@bind-Color="Options.LineColor"
									@bind-Alpha="Options.LineTransparency"
									ShowAlphaSlider="true" />

					<BitLabel>Grid Base Color</BitLabel>
					<BitColorPicker Style="width:100%; max-width:100%;"
									@bind-Color="Options.BaseColor"
									@bind-Alpha="Options.BaseTransparency"
									ShowAlphaSlider="true" />
				</BitStack>
			</BitAccordion>

			<BitAccordion Title="📷 Camera">
				<BitStack>
					<BitToggle Label="Which Coordinate is Up?" OnText="Z is Up" OffText="Y is Up" @bind-Value="Options.ZIsUp" />
					<BitToggle Label="Is View Projectsion or Orthographic?" OnText="Projection" OffText="Orthographic" @bind-Value="Options.IsProjectionCamera" />

					@if (Options.IsProjectionCamera)
					{
						<BitSlider Label="Field of View" @bind-Value="Options.Fov" Min="1" Max="179" Step="0.5" />
						<BitText Variant="BitTextVariant.Caption" Color="BitColor.SecondaryForeground">
							Controls perspective distortion
						</BitText>
					}
					else
					{
						<BitLabel>Orthographic Size: @Options.OrthoSize.ToString("F2")</BitLabel>
						<BitSlider @bind-Value="Options.OrthoSize" Min="1" Max="20" Step="0.1" />
						<BitText Variant="BitTextVariant.Caption" Color="BitColor.SecondaryForeground">
							Half-height of visible area
						</BitText>
					}

					<BitLabel>Near Clipping Plane: @Options.ZNear.ToString("F3")</BitLabel>
					<BitSlider @bind-Value="Options.ZNear" Min="0.001" Max="1" Step="0.001" />

					<BitLabel>Far Clipping Plane: @Options.ZFar.ToString("F0")</BitLabel>
					<BitSlider @bind-Value="Options.ZFar" Min="10" Max="999" Step="1" />

					<!-- Camera Controls Section -->
					<BitText Variant="BitTextVariant.H6">Orbit Constraints</BitText>
					<BitCheckbox @bind-Value="Options.ConstrainPolar" Label="Constrain Polar Angle" />

					@if (Options.ConstrainPolar)
					{
						<BitLabel>Max Polar Angle: @((Options.MaxPolar * 180 / Math.PI).ToString("F0"))°</BitLabel>
						<BitSlider @bind-Value="Options.MaxPolar" Min="0" Max="@(Math.PI * 0.5)" Step="0.01" />
						<BitLabel>Min Polar Angle: @((Options.MinPolar * 180 / Math.PI).ToString("F0"))°</BitLabel>
						<BitSlider @bind-Value="Options.MinPolar" Min="@(-Math.PI * 0.5)" Max="0" Step="0.01" />
					}

					<BitCheckbox @bind-Value="Options.ConstrainAzimuth" Label="Constrain Azimuth Angle" />

					@if (Options.ConstrainAzimuth)
					{
						<BitLabel>Max Azimuth Angle: @((Options.MaxAzimuth * 180 / Math.PI).ToString("F0"))°</BitLabel>
						<BitSlider @bind-Value="Options.MaxAzimuth" Min="@(-Math.PI)" Max="@Math.PI" Step="0.01" />
						<BitLabel>Min Azimuth Angle: @((Options.MinAzimuth * 180 / Math.PI).ToString("F0"))°</BitLabel>
						<BitSlider @bind-Value="Options.MinAzimuth" Min="@(-Math.PI)" Max="@Math.PI" Step="0.01" />
					}

					<!-- Distance Constraints -->
					<BitText Variant="BitTextVariant.H6">Distance Constraints</BitText>
					<BitCheckbox @bind-Value="Options.ConstrainDistance" Label="Constrain Distance" />

					@if (Options.ConstrainDistance)
					{
						<BitLabel>Max Distance: @Options.MaxDistance.ToString("F1")</BitLabel>
						<BitSlider @bind-Value="Options.MaxDistance" Min="1" Max="1000" Step="0.5" />
						<BitLabel>Min Distance: @Options.MinDistance.ToString("F2")</BitLabel>
						<BitSlider @bind-Value="Options.MinDistance" Min="0.1" Max="10" Step="0.1" />
					}

					<!-- Sensitivity Settings -->
					<BitText Variant="BitTextVariant.H6">Sensitivity Settings</BitText>
					<BitLabel>Orbit Sensitivity: @Options.OrbitSensitivity.ToString("F4")</BitLabel>
					<BitSlider @bind-Value="Options.OrbitSensitivity" Min="0.001" Max="0.01" Step="0.0001" />
					<BitLabel>Zoom Sensitivity: @Options.ZoomSensitivity.ToString("F4")</BitLabel>
					<BitSlider @bind-Value="Options.ZoomSensitivity" Min="0.0001" Max="0.005" Step="0.0001" />
					<BitLabel>Pan Sensitivity: @Options.PanSensitivity.ToString("F4")</BitLabel>
					<BitSlider @bind-Value="Options.PanSensitivity" Min="0.001" Max="0.02" Step="0.001" />
					<BitLabel>Pan Speed Multiplier (Shift): @Options.PanSpeedMultiplier.ToString("F1")</BitLabel>
					<BitSlider @bind-Value="Options.PanSpeedMultiplier" Min="1" Max="10" Step="0.5" />
				</BitStack>
			</BitAccordion>

			<!-- Rendering Section -->
			<BitAccordion Title="🎬 Rendering">
				<BitStack>
					<BitLabel>MSAA Sample Count</BitLabel>
					<BitDropdown @bind-Value="Options.SampleCount" Items="_sampleCountItems" Placeholder="Select sample count" />
					<BitText Variant="BitTextVariant.Caption" Color="BitColor.Warning">⚠️ Requires page refresh to take effect</BitText>

					@if (_showMsaaRefreshPrompt)
					{
						<div class="refresh-prompt">
							<BitText Variant="BitTextVariant.Body1" Color="BitColor.Warning">MSAA setting changed</BitText>
							<BitButton OnClick="RefreshPage" Color="BitColor.Warning" Variant="BitVariant.Fill" Class="refresh-btn">
								Refresh Page Now
							</BitButton>
						</div>
					}

					<BitButton OnClick="ResetToDefaults" Variant="BitVariant.Outline" FullWidth="true">Reset to Defaults</BitButton>
				</BitStack>
			</BitAccordion>
		</div>
	}
</div>

<style>
    .options-panel-container {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(30, 30, 30, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
        z-index: 1000;
        max-height: 90vh;
        overflow: hidden;
        transition: width 0.3s ease;
        display: inline-block; /* shrink to fit */
    }

    .options-panel-container.collapsed { width: auto; }

    .options-panel-container.expanded {
        width: fit-content;   /* content-driven */
        max-width: 300px;     /* cap width */
        min-width: 150px;     /* keep usable */
    }

    .options-content {
        width: 100%;
        padding: 0 12px 12px;
        max-height: calc(90vh - 60px);
        overflow-y: auto;
        box-sizing: border-box;
    }

    /* If you reintroduce a color grid, keep it from forcing width */
    .colors-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    @@media (max-width: 500px) {
        .options-panel-container.expanded { width: clamp(240px, 85vw, 380px); }
        .colors-grid { grid-template-columns: 1fr; }
    }

    .refresh-prompt {
        margin-top: 16px;
        padding: 12px;
        background: rgba(255, 193, 7, 0.15);
        border: 1px solid #ffc107;
        border-radius: 8px;
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
</style>

@code {
	[Parameter] public BugViewerOptions Options { get; set; }

	[Parameter] public bool IsExpanded { get; set; } = true;

	[Parameter] public EventCallback<bool> IsExpandedChanged { get; set; }

	[Inject] private NavigationManager Navigation { get; set; } = default!;

	private bool _showMsaaRefreshPrompt = false;

	private List<BitDropdownItem<int>> _sampleCountItems = new()
	{
		new() { Value = 1, Text = "1x - No anti-aliasing (fastest)" },
		new() { Value = 2, Text = "2x - Slight smoothing" },
		new() { Value = 4, Text = "4x - Smooth (recommended)" },
		new() { Value = 8, Text = "8x - Very smooth (slower)" }
	};

	protected override void OnInitialized()
	{
		base.OnInitialized();
		Options.PropertyChanged += OnOptionsPropertyChanged;
	}

	private void OnOptionsPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
	{
		if (e.PropertyName == nameof(BugViewerOptions.SampleCount))
		{
			_showMsaaRefreshPrompt = true;
			StateHasChanged();
		}
	}

	private async Task ToggleExpanded()
	{
		IsExpanded = !IsExpanded;
		await IsExpandedChanged.InvokeAsync(IsExpanded);
	}

	private void RefreshPage() => Navigation.NavigateTo(Navigation.Uri, forceLoad: true);

	private void ResetToDefaults()
	{
		Options.ResetToDefault();
		_showMsaaRefreshPrompt = false;
	}
}
